# BASED OFF OF THE Morphline from 
# https://github.com/romainr/hadoop-tutorials-examples/blob/master/solr-local-search/solr_local/reviews.conf

# Specify server locations in a SOLR_LOCATOR variable; used later in
# variable substitutions:
SOLR_LOCATOR : {
  # Name of solr collection
  collection : "${collection_name}"

  # ZooKeeper ensemble
  zkHost : "${zk_host}"
}

morphlines : [
  {
    id : ${collection_name}
    importCommands : ["org.kitesdk.**", "org.apache.solr.**"]
    commands : [
      {
        readCSV {
          separator : "${format_character(format['fieldSeparator'])}"
          columns : [
            % for field in fields:
            "${field['name']}" 
            %endfor
          ]
          quoteChar : "${format_character(format['quoteChar'])}"
          ignoreFirstLine : "${'true' if format['hasHeader'] else 'false'}"
          charset : UTF-8
        }
      }

      {
        generateUUID {
          field : ${uuid_name}
          type : "nonSecure"
        }
      }

      # require that all fields are present
      % for field in fields:
      {
        if {
          conditions : [
            { equals { "${field['name']}" : [] } }
          ]
          then : [
            { logTrace { format : "Ignoring record because it has no ${field['name']}: {}", args : ["@{}"] } }
            { dropRecord {} }    
          ]
        }
      }
      %endfor


      # require theat all fields match their expected type
      % for field in fields:
      {
        if {
          conditions : [
            { 
              grok { 
                expressions : {
                  "${field['name']}" : "${get_regex(field['type'])}"
                }
                extract : false

              } 
            }
          ]
          then : []
          else : [
            { logTrace { format : "Ignoring record due to incorrect type in ${field['name']}: {}", args : ["@{}"] } }
            { dropRecord {} }    
          ]
        }
      }
      %endfor

      # remove excess fields
      {
        sanitizeUnknownSolrFields {
          # Location from which to fetch Solr schema
          solrLocator : <%text>${SOLR_LOCATOR}</%text>
        }
      }

      # log the record at DEBUG level to SLF4J
      { logDebug { format : "output record: {}", args : ["@{}"] } }

      {
        loadSolr {         
          solrLocator : <%text>${SOLR_LOCATOR}</%text>
        }
      }


    ]
  }
]